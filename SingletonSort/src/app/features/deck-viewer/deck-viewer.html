<div class="app-container">
  <aside class="sidebar">
    <header class="sidebar-header">
      <div class="header-content">
        <div>
          <h1>Singleton Sort</h1>
          <p class="subtitle">Compare card lists</p>
        </div>
        <button (click)="shutdownServer()" class="shutdown-button" title="Shutdown Server">
          ‚úï
        </button>
      </div>
    </header>

    <div class="card-input-section">
      <h3>Add Deck</h3>
      <div class="input-group">
        <textarea
          [(ngModel)]="cardListText"
          placeholder="Paste your card list here (format: '1 Card Name' per line)"
          class="card-list-input"
          rows="8"
        ></textarea>
      </div>

      <div class="button-group">
        <button
          (click)="loadCardList()"
          [disabled]="!cardListText()"
          class="load-button"
        >
          Add Deck
        </button>

        @if (cardLists().length > 0) {
          <button (click)="clearAllCardLists()" class="clear-button">
            Clear All
          </button>
        }
      </div>

      @if (hasErrors()) {
        <div class="error-message">
          <div class="error-header">
            <strong>Errors:</strong>
            <button (click)="clearErrors()" class="close-button">√ó</button>
          </div>
          <ul class="error-list">
            @for (error of errors(); track error) {
              <li>{{ error }}</li>
            }
          </ul>
        </div>
      }
    </div>

    <div class="decks-sidebar-section">
      <div class="section-header">
        <h3>Loaded Decks ({{ cardLists().length }})</h3>
        <p class="hint">Click a deck to filter common cards</p>
      </div>
      <div class="decks-list">
        @for (deck of cardLists(); track $index) {
          <div class="deck-item" [class.selected]="isSelected($index)">
            <div class="deck-item-header">
              <input
                type="checkbox"
                [checked]="isSelected($index)"
                (change)="selectDeck($index)"
                class="deck-checkbox"
                title="Filter common cards by this deck"
              />

              <button
                (click)="toggleCollapse($index)"
                class="collapse-button"
                [attr.aria-expanded]="!deck.isCollapsed"
              >
                {{ deck.isCollapsed ? '‚ñ∂' : '‚ñº' }}
              </button>

              @if (!isEditing($index)) {
                <span (click)="startEditingName($index)" class="deck-name" title="Click to edit">
                  {{ deck.name }}
                </span>
              } @else {
                <div class="name-edit-container">
                  <input
                    type="text"
                    [(ngModel)]="editingName"
                    (keydown.enter)="saveName()"
                    (keydown.escape)="cancelEdit()"
                    class="name-edit-input"
                    autofocus
                  />
                  <button (click)="saveName()" class="save-button">‚úì</button>
                  <button (click)="cancelEdit()" class="cancel-button">‚úó</button>
                </div>
              }

              <div class="deck-item-actions">
                <button (click)="downloadCardList($index)" class="icon-button" title="Download">
                  ‚¨á
                </button>
                <button (click)="removeDeck($index)" class="icon-button remove" title="Remove">
                  ‚úï
                </button>
              </div>
            </div>

            @if (!deck.isCollapsed) {
              <div class="deck-item-content">
                <div class="deck-stats">
                  <span class="stat">{{ deck.totalCards }} cards</span>
                </div>
                <div class="cards-mini-list">
                  @for (card of deck.cards; track card.name) {
                    <div class="card-mini-item">
                      <span class="qty">{{ card.quantity }}√ó</span>
                      <span class="name">{{ card.name }}</span>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }

        @if (cardLists().length === 0) {
          <div class="empty-decks">
            <p>No decks loaded yet. Add a deck to get started!</p>
          </div>
        }
      </div>
    </div>
  </aside>

  <main class="main-content">
    @if (commonCards().length > 0) {
      <div class="common-cards-main">
        <header class="main-header">
          <div class="header-left">
            <h2>Common Cards</h2>
            @if (selectedDeckIndex() !== null) {
              <div class="filter-info">
                <span class="filter-label">Filtered by: {{ cardLists()[selectedDeckIndex()!]?.name }}</span>
                <button (click)="clearSelection()" class="clear-filter-button" title="Clear filter">
                  Clear
                </button>
              </div>
            }
          </div>
          <span class="count-badge">{{ commonCards().length }} cards</span>
        </header>

        <div class="common-cards-grid">
          @for (common of commonCards(); track common.name; let i = $index) {
            @if (i === 0 || common.group !== commonCards()[i - 1].group) {
              @if (common.group) {
                <div class="group-header">{{ common.group }}</div>
              } @else if (i > 0 && commonCards()[i - 1].group) {
                <div class="group-header">Other Cards</div>
              }
            }
            <div class="common-card-card">
              <div class="card-name-large">{{ common.name }}</div>
              <div class="deck-badges">
                @for (deckIndex of common.deckIndices; track deckIndex) {
                  <span class="deck-badge">{{ cardLists()[deckIndex]?.name }}</span>
                }
              </div>
            </div>
          }
        </div>
      </div>
    } @else {
      <div class="empty-main">
        <div class="empty-icon">üîç</div>
        <h2>No Common Cards Yet</h2>
        @if (cardLists().length < 2) {
          <p>Add at least 2 decks to see which cards appear in multiple lists.</p>
        } @else {
          <p>No cards appear in multiple decks. Your decks are completely unique!</p>
        }
      </div>
    }
  </main>
</div>
